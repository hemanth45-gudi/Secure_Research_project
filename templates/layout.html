<!doctype html>
<html lang="en">

<head>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <script>
    /**
     * Global JWT Helper (layout.html)
     * -------------------------------------------------------- 
     * HOW AUTH WORKS:
     *     On login, the server sets an HttpOnly cookie `srp_access_token`.
     *     Every browser page navigation automatically sends this cookie  
     *     Flask's jwt_required reads it, no JS needed for page loads.
     *     localStorage holds tokens for JS-based fetch() calls only.
     *     Server-side 401 on protected routes -> Flask redirects to /login.
     *
     * This script:
     *   1. Patches window.fetch to auto-attach Authorization header (for AJAX).
     *   2. Silently refreshes expired tokens via the refresh token.
     *   3. Exposes window.jwtLogout() for logout buttons.
     */
    (function () {
      const _originalFetch = window.fetch.bind(window);

      // Auto-refresh helper: exchanges refresh_token for a new access_token
      async function _refreshTokens() {
        const rt = localStorage.getItem('srp_refresh_token');
        if (!rt) return false;
        try {
          const res = await _originalFetch('/api/token/refresh', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ refresh_token: rt }),
          });
          if (!res.ok) return false;
          const data = await res.json();
          if (data.access_token) {
            localStorage.setItem('srp_access_token', data.access_token);
            return true;
          }
        } catch (_) { }
        return false;
      }

      // Patch fetch: attach Bearer token + retry once on TOKEN_EXPIRED
      window.fetch = async function (url, options = {}) {
        const t = localStorage.getItem('srp_access_token');
        if (t && !String(url).includes('/api/token/refresh')) {
          options.headers = options.headers || {};
          if (!options.headers['Authorization']) {
            options.headers['Authorization'] = 'Bearer ' + t;
          }
        }

        let resp = await _originalFetch(url, options);

        // Auto-refresh on TOKEN_EXPIRED
        if (resp.status === 401) {
          const clone = await resp.clone().json().catch(() => ({}));
          if (clone.code === 'TOKEN_EXPIRED') {
            const ok = await _refreshTokens();
            if (ok) {
              options.headers = options.headers || {};
              options.headers['Authorization'] = 'Bearer ' + localStorage.getItem('srp_access_token');
              resp = await _originalFetch(url, options);
            }
          }
        }
        return resp;
      };

      // Global logout   clears HttpOnly cookie (server) + localStorage
      window.jwtLogout = async function () {
        const rt = localStorage.getItem('srp_refresh_token');
        await _originalFetch('/api/logout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ refresh_token: rt || '' }),
        }).catch(() => { });
        localStorage.clear();
        window.location.href = '/login';
      };
    })();
  </script>
</head>

<body>
  <div class="container">
    <h2 class="text-center">  Secure Research Dataset System</h2>
    <hr>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </div>
</body>

</html>